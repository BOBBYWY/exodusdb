#!/bin/bash
set -eux

: ===============================================================
: Restore a postgres database from an sql dump to a _test database
: ===============================================================
:
:	'Syntax is ./doall <DBNAME> restore_db'
:	'       or ./restore_db <DBNAME> [<BACKUPDIR>] [OPTION]'
:	''
:   '       BACKUPDIR defaults to ~/backups/sql'
:	'		OPTION is N to NOT restart the target database service.'
:
	FROM_EXO_DATA=${1:?<DBNAME> argument is required.}
	NEW_BACKUP_DIR=${2:-~/backups/sql}
	RESTART=${3:-N}
:
	TO_EXO_DATA=${FROM_EXO_DATA}_test

:
: Check Syntax
: ============
:
	if [ -z "FROM_EXO_DATA"  -o  -z "$NEW_BACKUP_DIR" ]; then
		set +x
		echo 'Syntax is wrong. Cannot continue.'
		exit 1
	fi

:
: Stop the target database
: ========================
:
	./service ${FROM_EXO_DATA} stop test

#:
#: Give it a little time to stop
#: =============================
#:
#	sleep 5

:
: Kill any test process running the target database
: =================================================
:
	for PIDFILENAME in /run/serve_$APP_CODE/$TO_EXO_DATA.pid
	do
		kill -TERM `cat $PIDFILENAME` || true
	done

:
: Kill any existing connections to the target database
: ====================================================
:
: dropdb only has the force option from postgres v13
:
	sudo -u postgres psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$TO_EXO_DATA';"

:
: Drop the target database
: ========================
:
	sudo -u postgres dropdb --if-exists $TO_EXO_DATA

:
: Create the target database
: ==========================
:
	sudo -u postgres createdb --owner exodus --template template1 $TO_EXO_DATA

:
: Restore into the target database
: ================================
:
	set -o pipefail
	zcat $NEW_BACKUP_DIR/$FROM_EXO_DATA.sql.gz | sudo -u postgres psql $TO_EXO_DATA > /dev/null

:
: Recreate all functions
: ======================
:
	EXO_DATA=$TO_EXO_DATA dict2sql > /dev/null

:
: Optionally restart the target database
: ======================================
:
	if [ "$RESTART" != "N" ]; then
		./service ${FROM_EXO_DATA} start test
	fi

:
: Finished restore_db $1 in $(($SECONDS / 60)) minutes and $(($SECONDS % 60)) seconds.
: ======================================================
