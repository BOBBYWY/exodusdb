#!/bin/bash
set -eux

: ================================
: Copy all EXODUS programs to live
: ================================
:
: Syntax is:
: 	./copyall
:	./copyall CONFIRM
:

:
: Dry run or not
: ==============
:
	DRYRUN=--dry-run
	if [ "${1:-}" = "CONFIRM" ]; then
		DRYRUN=
	elif [ "${1:-}" != "" ]; then
:		Invalid syntax
		exit 1
	fi

:
: Create a directory for live services binaries
: =============================================
:
: May be used for EXODUS environment variable "EXO_HOME"
:
	mkdir -p $HOME/live

:
: Install the latest version of the neomail script into test
: ==========================================================
:
	rsync -av --whole-file neomail ~/bin

:
: Copy all bin and lib files to live
: ==================================
:
:	MUST use 'whole file' option to ensure that the OS dlopen understands everything has changed
:	otherwise new code may not become active and/or undefined behaviour i.e. crashes etc.

	#rsync -av ~/bin ~/lib ~/inc ~/live
	#rsync -a ~/{bin,lib,inc} ~/live
	#rsync -av --delete ~/{bin,lib} ~/live
	rsync $DRYRUN -av --whole-file ~/{bin,lib} ~/live

:
: Finished $DRYRUN copying EXOXUS programs to live in $(($SECONDS / 60)) minutes and $(($SECONDS % 60)) seconds.
: =========================================================================
:
: Warn DRYRUN if not CONFIRMed, or Restart required if CONFIRMed
: ==============================================================
:
	if [[ -n "$DRYRUN" ]]; then
:
: =============================================================================
: DRYRUN - - no CONFIRM provided
: =============================================================================
	else
: ============================================================================
: NOTE - You MUST restart all live processes URGENTLY otherwise they may crash
: ============================================================================
	fi

